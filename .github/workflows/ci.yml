name: CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:

jobs:
  build-test-release:
    name: Build & Test (Release)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          g++ \
          make \
          python3

    - name: Verify installations
      run: g++ --version && cmake --version && make --version && python3 --version

    - name: Build
      run: make build

    - name: Generate test data
      run: make tgen

    - name: Run tests
      run: make test-verbose

    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-release
        path: build/Testing/Temporary/
        retention-days: 7

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-release
        path: build/
        retention-days: 1


  build-test-debug:
    name: Build & Test (Debug)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          g++ \
          make \
          python3

    - name: Verify installations
      run: g++ --version && cmake --version && make --version && python3 --version

    - name: Build
      run: TYPE=Debug make build

    - name: Generate test data
      run: make tgen

    - name: Run tests
      run: make test-verbose

    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-debug
        path: build/Testing/Temporary/
        retention-days: 7

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-debug
        path: build/
        retention-days: 1

  build-test-tsan:
    name: Build & Test (Debug + TSan)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          g++ \
          make \
          python3

    - name: Verify installations
      run: g++ --version && cmake --version && make --version && python3 --version

    - name: Build
      run: TYPE=Debug TSAN=ON make build
      env:
        TSAN_OPTIONS: "halt_on_error=1 history_size=7 second_deadlock_stack=1"

    - name: Generate test data
      run: make tgen

    - name: Run tests
      run: make test-verbose
      env:
        TSAN_OPTIONS: "halt_on_error=1 history_size=7"

    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-tsan
        path: build/Testing/Temporary/
        retention-days: 7

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-tsan
        path: build/
        retention-days: 1

  lint:
    name: Code Formatting
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format

    - name: Check code formatting
      run: |
        find src include tests -name "*.cpp" -o -name "*.hpp" | xargs clang-format --dry-run -Werror
      continue-on-error: true

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [build-test-release, build-test-debug, build-test-tsan, lint]
    if: always()

    steps:
    - name: Check all jobs status
      run: |
        echo "Build & Test Results:"
        echo "  Release: ${{ needs.build-test-release.result }}"
        echo "  Debug: ${{ needs.build-test-debug.result }}"
        echo "  TSan: ${{ needs.build-test-tsan.result }}"
        echo "  Lint: ${{ needs.lint.result }}"
        
        if [ "${{ needs.build-test-release.result }}" != "success" ] || \
           [ "${{ needs.build-test-debug.result }}" != "success" ] || \
           [ "${{ needs.build-test-tsan.result }}" != "success" ]; then
          echo ""
          echo "❌ CI Failed - one or more test jobs failed"
          exit 1
        fi
        
        echo ""
        echo "✅ All builds and tests passed successfully!"

